<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ENHANCED: Hyros Email Detection Test</title>
  
  <!-- Your Hyros Script -->
  <script>
  var head = document.head;
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src = "https://t.partygo.mx/v1/lst/universal-script?ph=664ad84e5a8d71d02e5f8fe74e28bfe1eca5b5a982655b75fac5513b98d326d3&tag=!clicked&ref_url=" + encodeURI(document.URL);
  head.appendChild(script);
  console.log('🎯 ENHANCED: Hyros script loading...');
  </script>
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .button {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      margin: 8px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40,167,69,0.3);
    }
    .test-email-input {
      width: 300px;
      padding: 10px;
      border: 2px solid #28a745;
      border-radius: 5px;
      font-size: 14px;
      margin: 10px;
    }
    .log-monitor {
      background: #1a202c;
      color: #a0aec0;
      padding: 20px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
      border: 2px solid #2d3748;
    }
    h1 {
      color: #2d3748;
      text-align: center;
      background: linear-gradient(135deg, #28a745, #20c997);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎯 ENHANCED: Hyros Email Detection Test</h1>
    
    <div class="alert success">
      <h3>✅ SOLUTION: Hidden Email Input Method</h3>
      <p>This version creates a hidden email input that Hyros can monitor, then triggers email detection when SnapEngage captures an email.</p>
    </div>

    <div class="alert info">
      <h3>🔍 What to Look For:</h3>
      <p>When you test the chat, you should see <strong>[UTS] [hte]</strong> appear in the console logs, indicating Hyros detected the email.</p>
    </div>

    <h2>🧪 Enhanced Tests</h2>
    
    <div style="margin: 20px 0;">
      <h3>Test 1: Direct Email Detection Trigger</h3>
      <input type="email" id="test-email" class="test-email-input" placeholder="Enter test email..." value="">
      <button class="button" onclick="testDirectEmailDetection()">
        🎯 Trigger Hyros Email Detection
      </button>
      <p><small>This should trigger <strong>[UTS] [hte]</strong> in console</small></p>
    </div>

    <div style="margin: 20px 0;">
      <h3>Test 2: Chat Widget with Enhanced Detection</h3>
      <button class="button" onclick="testEnhancedChatWidget()">
        💬 Test Enhanced Chat Widget
      </button>
      <p><small>This will open chat and trigger enhanced Hyros detection</small></p>
    </div>

    <div style="margin: 20px 0;">
      <h3>Test 3: Monitor Hidden Input</h3>
      <button class="button" onclick="checkHiddenInput()">
        🔍 Check Hidden Email Input
      </button>
      <p><small>Verify the hidden input was created correctly</small></p>
    </div>

    <h2>📊 Console Monitor</h2>
    <div id="console-monitor" class="log-monitor">
      <div style="color: #4fd1c7;">[Enhanced Test] Monitoring console for Hyros email detection...</div>
    </div>

    <div class="alert warning">
      <h3>🎯 Expected Behavior:</h3>
      <ol>
        <li><strong>Hidden email input created</strong> → Hyros can monitor it</li>
        <li><strong>Chat email captured</strong> → Email copied to hidden input</li>
        <li><strong>Events triggered</strong> → focus, blur, input, change events</li>
        <li><strong>Hyros detects email</strong> → <strong>[UTS] [hte]</strong> appears in console</li>
        <li><strong>Tracking fires</strong> → Email sent to Hyros for attribution</li>
      </ol>
    </div>
  </div>

  <script>
    // Monitor console for Hyros messages
    var originalConsoleLog = console.log;
    console.log = function() {
      // Call original console.log
      originalConsoleLog.apply(console, arguments);
      
      // Add to our monitor
      var args = Array.prototype.slice.call(arguments);
      var message = args.join(' ');
      
      var monitor = document.getElementById('console-monitor');
      var timestamp = new Date().toLocaleTimeString();
      var logEntry = document.createElement('div');
      
      // Highlight important Hyros messages
      if (message.includes('[UTS] [hte]')) {
        logEntry.style.color = '#48bb78';
        logEntry.innerHTML = '[' + timestamp + '] 🎉 SUCCESS: ' + message;
      } else if (message.includes('[UTS]')) {
        logEntry.style.color = '#4299e1';
        logEntry.innerHTML = '[' + timestamp + '] ' + message;
      } else if (message.includes('SnapEngage-Hyros')) {
        logEntry.style.color = '#ed8936';
        logEntry.innerHTML = '[' + timestamp + '] ' + message;
      } else {
        logEntry.style.color = '#a0aec0';
        logEntry.innerHTML = '[' + timestamp + '] ' + message;
      }
      
      monitor.appendChild(logEntry);
      monitor.scrollTop = monitor.scrollHeight;
    };

    function testDirectEmailDetection() {
      var email = document.getElementById('test-email').value;
      if (!email) {
        alert('Please enter a test email');
        return;
      }
      
      console.log('🧪 Testing direct Hyros email detection with: ' + email);
      
      if (window.SnapEngageUtils && window.SnapEngageUtils.triggerHyrosEmail) {
        window.SnapEngageUtils.triggerHyrosEmail(email);
        console.log('✅ Enhanced email detection triggered');
      } else {
        console.log('❌ Enhanced utils not available yet');
        
        // Fallback: try to find and fill hidden input manually
        var hiddenInput = document.getElementById('hyros-email-trigger-input');
        if (hiddenInput) {
          console.log('📧 Found hidden input, filling with email');
          hiddenInput.value = email;
          
          // Trigger events
          var events = ['input', 'change', 'keyup', 'keydown', 'blur', 'focus'];
          events.forEach(function(eventType) {
            var event = new Event(eventType, { bubbles: true, cancelable: true });
            hiddenInput.dispatchEvent(event);
          });
          
          hiddenInput.focus();
          setTimeout(function() {
            hiddenInput.blur();
            console.log('🎯 Manually triggered email events');
          }, 100);
        } else {
          console.log('❌ Hidden input not found');
        }
      }
    }

    function testEnhancedChatWidget() {
      console.log('🧪 Testing enhanced chat widget...');
      
      if (!window.SnapEngageUtils) {
        alert('❌ SnapEngage not loaded yet. Please wait and try again.');
        return;
      }
      
      if (!window.SnapEngageUtils.isLoaded()) {
        alert('⚠️ SnapEngage still initializing. Please wait and try again.');
        return;
      }
      
      var testEmail = 'enhanced-test-' + Date.now() + '@example.com';
      console.log('📧 Using test email: ' + testEmail);
      
      // Set email in SnapEngage
      if (typeof SnapEngage !== 'undefined') {
        try {
          SnapEngage.setUserEmail(testEmail);
          SnapEngage.setUserName('Enhanced Test User');
          console.log('✅ Set test email in SnapEngage');
          
          // Also trigger our enhanced detection
          if (window.SnapEngageUtils.triggerHyrosEmail) {
            window.SnapEngageUtils.triggerHyrosEmail(testEmail);
            console.log('🎯 Pre-triggered enhanced email detection');
          }
        } catch (e) {
          console.log('⚠️ Could not set email: ' + e.message);
        }
      }
      
      // Open chat
      window.SnapEngageUtils.openChat('Testing ENHANCED Hyros email detection with: ' + testEmail);
      console.log('💬 Enhanced chat opened - watch for [UTS] [hte] in logs!');
    }

    function checkHiddenInput() {
      console.log('🔍 Checking hidden email input...');
      
      var hiddenForm = document.getElementById('hyros-email-trigger-form');
      var hiddenInput = document.getElementById('hyros-email-trigger-input');
      
      if (hiddenForm && hiddenInput) {
        console.log('✅ Hidden form and input found');
        console.log('📧 Hidden input value:', hiddenInput.value);
        console.log('🎯 Hidden input type:', hiddenInput.type);
        console.log('📝 Hidden input name:', hiddenInput.name);
        
        // Test the input
        var testEmail = 'test-hidden-' + Date.now() + '@example.com';
        hiddenInput.value = testEmail;
        
        // Trigger events
        hiddenInput.focus();
        hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
        hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        setTimeout(function() {
          hiddenInput.blur();
          console.log('🧪 Tested hidden input with email: ' + testEmail);
        }, 100);
        
      } else {
        console.log('❌ Hidden input not found - integration may not be loaded');
        
        if (!hiddenForm) console.log('❌ Missing: hyros-email-trigger-form');
        if (!hiddenInput) console.log('❌ Missing: hyros-email-trigger-input');
      }
    }

    // Enhanced event handlers
    window.onSnapEngageChatStart = function(email, message, type) {
      console.log('🎉 ENHANCED: Chat started with email detection!');
      console.log('📧 Email:', email);
      console.log('💬 Message:', message);
      console.log('🔄 Type:', type);
      
      if (email) {
        console.log('🎯 ENHANCED: Email should trigger Hyros detection automatically');
        console.log('👀 WATCH FOR: [UTS] [hte] in the console logs above');
      }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 Enhanced test page loaded');
      console.log('⏳ Waiting for enhanced SnapEngage integration...');
      
      // Check for integration every 2 seconds
      var checkCount = 0;
      var checker = setInterval(function() {
        checkCount++;
        
        if (window.SnapEngageUtils) {
          console.log('✅ Enhanced SnapEngage utils detected');
          clearInterval(checker);
          
          // Check for hidden input
          setTimeout(function() {
            var hiddenInput = document.getElementById('hyros-email-trigger-input');
            if (hiddenInput) {
              console.log('✅ Hidden email input created successfully');
            } else {
              console.log('⚠️ Hidden email input not found');
            }
          }, 1000);
          
        } else if (checkCount >= 10) {
          console.log('❌ Enhanced integration failed to load after 20 seconds');
          clearInterval(checker);
        } else {
          console.log('⏳ Still waiting for enhanced integration... (' + checkCount + '/10)');
        }
      }, 2000);
    });

    // Test function for clients to verify
    window.testHyrosEmailDetection = function(email) {
      email = email || 'client-test-' + Date.now() + '@example.com';
      console.log('🧪 CLIENT TEST: Testing Hyros email detection with: ' + email);
      
      // Method 1: Use our enhanced trigger
      if (window.SnapEngageUtils && window.SnapEngageUtils.triggerHyrosEmail) {
        window.SnapEngageUtils.triggerHyrosEmail(email);
        console.log('✅ Used enhanced trigger method');
      }
      
      // Method 2: Direct input manipulation
      var hiddenInput = document.getElementById('hyros-email-trigger-input');
      if (hiddenInput) {
        hiddenInput.value = email;
        hiddenInput.focus();
        hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
        hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        hiddenInput.dispatchEvent(new Event('keyup', { bubbles: true }));
        setTimeout(function() {
          hiddenInput.blur();
          console.log('✅ Used direct input method');
        }, 200);
      }
      
      console.log('👀 LOOK FOR: [UTS] [hte] in console to confirm Hyros detected the email');
      return email;
    };
  </script>

  <!-- Load Enhanced SnapEngage with Hyros Email Detection -->
  <script src="https://callwithcarlos.com/snapengage/chat.php?debug=true&hyros=true"></script>

</body>
</html>